---
import AppLayout from '../../layouts/AppLayout.astro';
import { AdminDashboardPage } from '../../components/pages/AdminDashboardPage';
import { getSession } from '@/lib/auth/session';
import { db } from '@/lib/db';
import { users } from '@/lib/db/schema';
import { eq } from 'drizzle-orm';

const session = await getSession(Astro);

if (!session) {
  return Astro.redirect('/auth/login');
}

// Server-side super_admin check
const [user] = await db
  .select({ role: users.role })
  .from(users)
  .where(eq(users.id, session.user.id))
  .limit(1);

if (user?.role !== 'super_admin') {
  return Astro.redirect('/');
}
---

<AppLayout title="Admin Dashboard">
  <AdminDashboardPage client:only="react" />
</AppLayout>
